{% extends "base.html" %}
{% block lab %}РГЗ{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='rgz/rgz.css') }}">
{% endblock %}

{% block script %}
<script>
let currentPage = 1;
let currentSearchTerm = '';
let currentMaxPrice = '';
let currentPrescriptionOnly = false;

function searchMedicines() { 
    const url = '/rgz/json-rpc-api/'; 
    const json = {
        'jsonrpc': '2.0',
        'method': 'search_medicines',
        'params': {
            'page': currentPage,
            'search_term': currentSearchTerm,
            'max_price': currentMaxPrice,
            'prescription_only': currentPrescriptionOnly
        },
        'id': Math.round(Math.random() * 1000)
    };
    
    fetch(url, { //отправляем запрос на сервер
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(json)
    })
    .then(function(response) {
        return response.json();
    })
    .then(function(data) {
        if (data.error) {
            console.error('Error:', data.error);
            showMessage('Ошибка при поиске: ' + data.error.message, 'error');
            return;
        }
        
        displayMedicines(data.result);
    })
    .catch(function(error) { //ловит ошибки до получения ответа от сервера (нет интернета)
        console.error('Fetch error:', error);
        showMessage('Ошибка соединения', 'error');
    });
}

function displayMedicines(result) {
    const medicinesList = document.getElementById('medicines-list'); //готовим место
    const paginationInfo = document.getElementById('pagination-info');
    const pharmacistPanel = document.getElementById('pharmacist-panel');
    
    medicinesList.innerHTML = '';
    
    if (result.medicines.length === 0) {
        medicinesList.innerHTML = '<div class="no-medicines">Лекарства не найдены</div>';
        paginationInfo.innerHTML = '';
        return;
    }
    
    result.medicines.forEach(medicine => {
        const medicineElement = document.createElement('div');
        medicineElement.className = 'medicine-card';

        medicineElement.dataset.id = medicine.id;
        medicineElement.dataset.name = medicine.name;
        medicineElement.dataset.genericname = medicine.generic_name;
        medicineElement.dataset.prescription = medicine.prescription;
        medicineElement.dataset.price = medicine.price;
        medicineElement.dataset.quantity = medicine.quantity;

        medicineElement.innerHTML = `
            <div class="medicine-header">
                <h3 class="medicine-name">${medicine.name}</h3>
                <span class="medicine-price">${medicine.price.toFixed(2)} руб.</span>
            </div>
            <div class="medicine-info">
                <p><strong>Непатентованное название:</strong> ${medicine.generic_name}</p>
                <p><strong>Рецептурный:</strong> 
                    ${medicine.prescription ? '<span class="prescription-badge">да</span>' : 'нет'}
                </p>
                <p><strong>Наличие:</strong> 
                    <span class="${medicine.quantity === 0 ? 'out-of-stock' : 'in-stock'}">
                        ${medicine.availability}
                    </span>
                </p>
            </div>
            ${pharmacistPanel ? `
            <div class="medicine-actions">
                <button class="btn btn-edit" onclick="openEditModal(${medicine.id})">Редактировать</button>
                <button class="btn btn-delete" onclick="deleteMedicine(${medicine.id})">Удалить</button>
            </div>
            ` : ''}
        `;
        medicinesList.appendChild(medicineElement);
    });
    
    // Пагинация
    paginationInfo.innerHTML = `
        <div class="pagination">
            <button class="btn btn-prev" ${!result.has_prev ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">← Предыдущие</button>
            <span class="page-info">Страница ${currentPage} из ${Math.ceil(result.total / 10)}</span>
            <button class="btn btn-next" ${!result.has_next ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">Следующие →</button>
        </div>
        <div class="total-info">Найдено лекарств: ${result.total}</div>
    `;
}

//смена страницы в пагинации
function changePage(page) {
    currentPage = page;
    searchMedicines();
}

//берем значения из нашей формы
function applySearch() {
    currentSearchTerm = document.getElementById('search-term').value;
    currentMaxPrice = document.getElementById('max-price').value;
    currentPrescriptionOnly = document.getElementById('prescription-only').checked;
    currentPage = 1;
    searchMedicines();
}

function resetSearch() {
    document.getElementById('search-term').value = '';
    document.getElementById('max-price').value = '';
    document.getElementById('prescription-only').checked = false;
    currentSearchTerm = '';
    currentMaxPrice = '';
    currentPrescriptionOnly = false;
    currentPage = 1;
    searchMedicines();
}

function showAllMedicines() {
    currentSearchTerm = '';
    currentMaxPrice = '';
    currentPrescriptionOnly = false;
    currentPage = 1;
    searchMedicines();
}

//функции фармацевта
function loginPharmacist() {
    const username = document.getElementById('pharmacist-username').value;
    const password = document.getElementById('pharmacist-password').value;
    
    if (!username || !password) {
        showMessage('Введите логин и пароль', 'error');
        return;
    }
    
    fetch('/rgz/login', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({username, password})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            location.reload();
        } else {
            showMessage(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Login error:', error);
        showMessage('Ошибка соединения', 'error');
    });
}

function addMedicine() {
    const name = document.getElementById('new-name').value;
    const genericName = document.getElementById('new-generic-name').value;
    const prescription = document.getElementById('new-prescription').checked;
    const price = document.getElementById('new-price').value;
    const quantity = document.getElementById('new-quantity').value;
    
    if (!name || !genericName || !price || !quantity) {
        showMessage('Заполните все обязательные поля', 'error');
        return;
    }
    
    const priceValue = parseFloat(price);
    if (priceValue <= 0) {
        showMessage('Цена должна быть положительным числом', 'error');
        return;
    }

    const quantityValue = parseInt(quantity);
    if (quantityValue < 0) {
        showMessage('Количество не может быть отрицательным', 'error');
        return;
    }
    
    const json = {
        'jsonrpc': '2.0',
        'method': 'add_medicine',
        'params': {
            'name': name,
            'generic_name': genericName,
            'prescription': prescription,
            'price': priceValue,
            'quantity': quantityValue
        },
        'id': Math.round(Math.random() * 1000)
    };
    
    fetch('/rgz/json-rpc-api/', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(json)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showMessage('Ошибка: ' + data.error.message, 'error');
        } else {
            document.getElementById('add-medicine-form').reset();
            searchMedicines();
            showMessage('Лекарство успешно добавлено!', 'success');
        }
    })
    .catch(error => {
        console.error('шибка при добавлении лекарства:', error);
        showMessage('Ошибка соединения', 'error');
    });
}

function deleteMedicine(medicineId) {
    if (!confirm('Вы уверены, что хотите удалить это лекарство?')) return;
    
    const json = {
        'jsonrpc': '2.0',
        'method': 'delete_medicine',
        'params': medicineId,
        'id': Math.round(Math.random() * 1000)
    };
    
    fetch('/rgz/json-rpc-api/', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(json)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showMessage('Ошибка: ' + data.error.message, 'error');
        } else {
            searchMedicines();
            showMessage('Лекарство успешно удалено!', 'success');
        }
    })
    .catch(error => {
        console.error('Ошибка удаления лекарства:', error);
        showMessage('Ошибка соединения', 'error');
    });
}

function openEditModal(medicineId) {
    const card = document.querySelector(`.medicine-card[data-id="${medicineId}"]`);
    
    if (!card) {
        showMessage('Лекарство не найдено', 'error');
        return;
    }
    
    document.getElementById('edit-id').value = card.dataset.id;
    document.getElementById('edit-name').value = card.dataset.name;
    document.getElementById('edit-generic-name').value = card.dataset.genericname;
    document.getElementById('edit-prescription').checked = card.dataset.prescription === 'true';
    document.getElementById('edit-price').value = card.dataset.price;
    document.getElementById('edit-quantity').value = card.dataset.quantity;
    
    document.getElementById('edit-error').style.display = 'none'; //убрать старую ошибку, если она была
    document.getElementById('edit-modal').style.display = 'block';
}

function closeEditModal() {
    document.getElementById('edit-modal').style.display = 'none';
    document.getElementById('edit-error').style.display = 'none';
}

function saveMedicine() {
    const id = document.getElementById('edit-id').value;
    const name = document.getElementById('edit-name').value;
    const genericName = document.getElementById('edit-generic-name').value;
    const price = document.getElementById('edit-price').value;
    const quantity = document.getElementById('edit-quantity').value;
    const prescription = document.getElementById('edit-prescription').checked;
    const errorElement = document.getElementById('edit-error');
    
    //Скрываем предыдущую ошибку
    errorElement.style.display = 'none';
    errorElement.textContent = '';
  
    if (!name || !genericName || !price || !quantity) {
        showEditError('Заполните все обязательные поля');
        return;
    }
    
    const priceValue = parseFloat(price);
    if (priceValue <= 0) {
        showEditError('Цена должна быть положительным числом');
        return;
    }
    
    const quantityValue = parseInt(quantity);
    if (quantityValue < 0) {
        showEditError('Количество не может быть отрицательным');
        return;
    }
    
    const json = {
        'jsonrpc': '2.0',
        'method': 'edit_medicine',
        'params': {
            'id': parseInt(id),
            'name': name,
            'generic_name': genericName,
            'prescription': prescription,
            'price': priceValue,
            'quantity': quantityValue
        },
        'id': Math.round(Math.random() * 1000)
    };
    
    fetch('/rgz/json-rpc-api/', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(json)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showEditError('Ошибка: ' + data.error.message);
        } else {
            closeEditModal();
            searchMedicines();
            showMessage('Лекарство успешно обновлено!', 'success');
        }
    })
    .catch(error => {
        showEditError('Ошибка соединения: ' + error.message);
    });
}

function showEditError(message) {
    const errorElement = document.getElementById('edit-error');
    errorElement.textContent = message;
    errorElement.style.display = 'block';
}

function showMessage(message, type) { //показываем временное сообщение вверху страницы
    const messageElement = document.getElementById('message');
    messageElement.textContent = message;
    messageElement.className = `message ${type}`;
    messageElement.style.display = 'block';
    
    setTimeout(() => {
        messageElement.style.display = 'none';
    }, 5000);
}

// Инициализация при загрузке
document.addEventListener('DOMContentLoaded', function() {
    searchMedicines();
});
</script>
{% endblock %}

{% block main %}
<div class="pharmacy-container">
    <div class="pharmacy-header">
        {% if session.get('pharmacist_logged_in') %}
        <div class="pharmacist-info">
            Фармацевт: {{ session.get('pharmacist_username') }}
            <a href="/rgz/logout" class="btn btn-logout">Выйти</a>
        </div>
        {% endif %}
        <h1>Аптека "Витаминка"</h1>
        <p class="pharmacy-subtitle">Ваше здоровье - наша забота</p>
    </div>
  
    <div class="search-section">
        <h2>Поиск лекарств</h2>
        <div class="search-form">
            <div class="search-group">
                <input type="text" id="search-term" placeholder="Название или непатентованное название">
                <input type="number" id="max-price" placeholder="Максимальная цена" step="0.01" min="0">
            </div>
            <div class="search-options">
                <label class="checkbox-label"><input type="checkbox" id="prescription-only"> Только рецептурные</label>
                <br>
                <button class="btn btn-search" onclick="applySearch()">Найти</button>
                <button class="btn btn-reset" onclick="resetSearch()">Сбросить</button>
                <button class="btn btn-show-all" onclick="showAllMedicines()">Показать все лекарства</button>
            </div>
        </div>
    </div>

    {% if not session.get('pharmacist_logged_in') %}
    <div id="pharmacist-login" class="pharmacist-section">
        <h2>Вход для фармацевта</h2>
        <div class="pharmacist-login-form">
            <input type="text" id="pharmacist-username" placeholder="Логин">
            <input type="password" id="pharmacist-password" placeholder="Пароль">
            <button class="btn btn-login" onclick="loginPharmacist()">Войти</button>
        </div>
    </div>
    {% else %}
    <div id="pharmacist-panel" class="pharmacist-section">
        <h2>Панель фармацевта <i>(добавление нового лекарства)</i></h2>
        <div class="add-medicine-form">
            <form id="add-medicine-form">
                <div class="form-row">
                    <input type="text" id="new-name" placeholder="Торговое название*" required>
                    <input type="text" id="new-generic-name" placeholder="Непатентованное название*" required>
                </div>
                <br>
                <div class="form-row">
                    <input type="number" id="new-price" placeholder="Цена*" step="0.01" min="0.01" required>
                    <input type="number" id="new-quantity" placeholder="Количество*" min="0" required>
                </div>
            </form>
        </div>
        <br>
        <div class="form-options">
            <label class="checkbox-label">
                <input type="checkbox" id="new-prescription">
                Рецептурный препарат
            </label>
            <br>
            <button type="button" class="btn btn-add" onclick="addMedicine()">Добавить лекарство</button>
        </div>
    </div>
    {% endif %}
    
    <div id="medicines-list" class="medicines-grid"></div>
    
    <div id="pagination-info" class="pagination-container"></div>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2>Редактировать лекарство</h2>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <div class="form-group">
                    <input type="text" id="edit-name" placeholder="Торговое название" required>
                    <input type="text" id="edit-generic-name" placeholder="Непатентованное название" required>
                    <input type="number" id="edit-price" placeholder="Цена" step="0.01" min="0.01" required>
                    <input type="number" id="edit-quantity" placeholder="Количество" min="0" required>
                    <label class="checkbox-label"><input type="checkbox" id="edit-prescription">Рецептурный препарат</label>
                    <div id="edit-error" class="error-message" style="display: none;"></div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeEditModal()">Отмена</button>
                    <button type="button" class="btn btn-save" onclick="saveMedicine()">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='lab9/lab9.css') }}">
{% endblock %}

{% block script %}
<script>
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', loadSessionInfo);
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –∫–æ—Ä–æ–±–∫–∞—Ö
    function loadSessionInfo() {
        fetch('/lab9/rest-api/session')
        .then(function(response) {
            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            return response.json();
        })
        .then(function(data) {
            if (data.error) throw new Error(data.error);
            updateUI(data);
            generateBoxes(data.boxes);
        })
        .catch(function(error) {
            console.error('Error:', error);
            showError(error.message);
        });
    }
    
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–æ—Ä–æ–±–∫–∏
    function openBox(boxId) {
        fetch(`/lab9/rest-api/boxes/${boxId}/open`, {method: 'POST'})
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.error) throw new Error(data.error);
            showGift(data);
            loadSessionInfo();
        })
        .catch(function(error) {
            showError(error.message);
        });
    }
    
    // –°–±—Ä–æ—Å –∫–æ—Ä–æ–±–æ–∫
    function resetAllBoxes() {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∫–æ—Ä–æ–±–∫–∏?')) return;
        
        fetch('/lab9/rest-api/boxes/reset', {method: 'POST'})
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.error) throw new Error(data.error);
            showSuccess(data.message);
            loadSessionInfo();
            hideGiftDisplay();
        })
        .catch(function(error) {
            showError(error.message);
        });
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    function updateUI(data) {
        document.getElementById('opened-count').textContent = data.stats.opened_count;
        document.getElementById('remaining-count').textContent = data.stats.remaining;
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        if (data.authenticated) {
        const userInfo = document.querySelector('.user-info');
        if (userInfo) {
            const span = userInfo.querySelector('span') || document.createElement('span');
            span.textContent = '–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: ' + data.login;
            userInfo.prepend(span);
        }
    }        
        // –°–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –≤—Ö–æ–¥
        const authLinks = document.querySelector('.stats p:nth-child(2)');
        if (authLinks) authLinks.style.display = data.authenticated ? 'none' : 'block';
        
        // –°–æ–æ–±—â–µ–Ω–∏–µ
        const message = document.querySelector('.message p');
        if (message) {
            if (data.stats.opened_count >= data.stats.max_open) {
                message.textContent = '–í—ã –æ—Ç–∫—Ä—ã–ª–∏ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ—Ä–æ–±–∫–∏!';
                message.style.color = '#4CAF50';
            } else {
                message.textContent = '–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ—Ä–æ–±–∫—É, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–¥–∞—Ä–æ–∫';
                message.style.color = '';
            }
        }
    }
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ—Ä–æ–±–æ–∫
    function generateBoxes(boxes) {
    const container = document.querySelector('.boxes-container');
    container.innerHTML = '';
    
    boxes.forEach(function(box) {      
        const html = `
            <div class="box-wrapper" style="top:${box.top}%; left:${box.left}%">
                <div class="box ${box.opened ? 'opened' : ''}">
                    ${box.can_open && !box.opened ? 
                        `<button class="box-btn" onclick="openBox(${box.id})">
                            <img src="${box.gift_image}" alt="–ö–æ—Ä–æ–±–∫–∞ ${box.number}">
                        </button>` :
                        `<div class="box-btn">
                            <img src="${box.gift_image}" alt="–ö–æ—Ä–æ–±–∫–∞ ${box.number}">
                            ${box.opened ? '<span class="opened-label">‚úì</span>' : ''}
                            ${!box.opened && box.require_auth ? '<span class="lock-label">üîí</span>' : ''}
                        </div>`
                    }
                    <div class="box-number">${box.number}</div>
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', html);
    });
}
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–π –ø–æ–¥–∞—Ä–æ–∫
    function showGift(data) {
    document.querySelector('.gift-display')?.remove();
    
    document.querySelector('.boxes-container')
        .insertAdjacentHTML('afterend', `
            <div class="gift-display">
                <h3>üéâ –ö–æ—Ä–æ–±–∫–∞ ‚Ññ${data.number} –æ—Ç–∫—Ä—ã—Ç–∞!</h3>
                <p>${data.congratulation}</p>
                <img src="${data.gift_image}" alt="–ü–æ–¥–∞—Ä–æ–∫" class="gift-img"> 
            </div>
        `);
}
    
    // –°–∫—Ä—ã—Ç—å –ø–æ–¥–∞—Ä–æ–∫
    function hideGiftDisplay() {
        const giftDisplay = document.querySelector('.gift-display');
        if (giftDisplay) giftDisplay.remove();
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
    function showError(message) {
        removeOldMessages();
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error';
        errorDiv.textContent = message;
        
        const h1 = document.querySelector('h1');
        if (h1 && h1.parentNode) {
            h1.parentNode.insertBefore(errorDiv, h1.nextSibling);
        }
        
        setTimeout(function() {
            if (errorDiv.parentNode) errorDiv.remove();
        }, 5000);
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —É—Å–ø–µ—Ö
    function showSuccess(message) {
        removeOldMessages();
        
        const successDiv = document.createElement('div');
        successDiv.className = 'success';
        successDiv.textContent = message;
        
        const h1 = document.querySelector('h1');
        if (h1 && h1.parentNode) {
            h1.parentNode.insertBefore(successDiv, h1.nextSibling);
        }
        
        setTimeout(function() {
            if (successDiv.parentNode) successDiv.remove();
        }, 5000);
    }

    // –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    function removeOldMessages() {
        document.querySelectorAll('.error, .success').forEach(el => el.remove());
    }
    
</script>
{% endblock %}

{% block main %}
<h1>üéÅ–ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—èüéÅ</h1>

{% if auth %}
<div class="user-info">
    <span>–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: {{ login }}</span> | <a href="/lab9/logout">–í—ã–π—Ç–∏</a>
    <form class="santa-form">
        <button type="button" class="santa-btn" onclick="resetAllBoxes()">üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑</button>
    </form>
</div>
{% endif %}

<div class="stats">
    <p>–û—Ç–∫—Ä—ã—Ç–æ: <span id="opened-count">0</span>/3 | –û—Å—Ç–∞–ª–æ—Å—å: <span id="remaining-count">10</span></p>
    {% if not auth %}
    <p><a href="/lab9/login"><i>–í–æ–π—Ç–∏</i></a> | <a href="/lab9/register"><i>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</i></a></p>
    {% endif %}
</div>

<div class="boxes-container">
    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ—Ä–æ–±–æ–∫...</div>
</div>

<div class="message">
    <p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ—Ä–æ–±–∫—É, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–¥–∞—Ä–æ–∫</p>
</div>
{% endblock %}
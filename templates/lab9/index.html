{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='lab9/lab9.css') }}">
{% endblock %}

{% block script %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        loadSessionInfo();
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –î–µ–¥ –ú–æ—Ä–æ–∑
        const santaBtn = document.querySelector('.santa-btn');
        if (santaBtn) {
            santaBtn.addEventListener('click', function(e) {
                e.preventDefault();
                resetAllBoxes();
            });
        }
    });
    
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Å—Å–∏–∏ –∏ –∫–æ—Ä–æ–±–∫–∞—Ö
    function loadSessionInfo() {
        fetch('/lab9/rest-api/session')
            .then(response => {
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                updateUI(data);
                generateBoxes(data.boxes);
            })
            .catch(error => {
                console.error('Error:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            });
    }
    
    // –û—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∫–æ—Ä–æ–±–∫—É
    function openBox(boxId) {
        fetch(`/lab9/rest-api/boxes/${boxId}/open`, {
            method: 'POST',
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                showError(data.error);
            } else {
                showGift(data);
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Å—Å–∏–∏
                loadSessionInfo();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError(error.message);
        });
    }
    
    // –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∫–æ—Ä–æ–±–∫–∏
    function resetAllBoxes() {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∫–æ—Ä–æ–±–∫–∏? –î–µ–¥ –ú–æ—Ä–æ–∑ –Ω–∞–ø–æ–ª–Ω–∏—Ç –∏—Ö –∑–∞–Ω–æ–≤–æ!')) {
            return;
        }
        
        fetch('/lab9/rest-api/boxes/reset', {
            method: 'POST',
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                showError(data.error);
            } else {
                showSuccess(data.message);
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Å—Å–∏–∏
                loadSessionInfo();
                hideGiftDisplay();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showError(error.message);
        });
    }
    
    // –û–±–Ω–æ–≤–∏—Ç—å UI –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö
    function updateUI(data) {
        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        const openedCount = data.stats.opened_count;
        const remaining = data.stats.remaining;
        const maxOpen = data.stats.max_open;
        
        document.getElementById('opened-count').textContent = openedCount;
        document.getElementById('remaining-count').textContent = remaining;
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        updateUserInfo(data.authenticated, data.login);
        
        // –°–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç–æ
        const messageElement = document.querySelector('.message p');
        if (openedCount >= maxOpen) {
            messageElement.textContent = '–í—ã –æ—Ç–∫—Ä—ã–ª–∏ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ—Ä–æ–±–∫–∏!';
            messageElement.style.color = '#4CAF50';
        } else {
            messageElement.textContent = '–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ—Ä–æ–±–∫—É, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–¥–∞—Ä–æ–∫';
            messageElement.style.color = '';
        }
    }
    
    function updateUserInfo(isAuth, login) {
        const userInfoElement = document.querySelector('.user-info');
        const authLinksElement = document.querySelector('.stats p:nth-child(2)');
        
        if (isAuth && userInfoElement) {
            const span = userInfoElement.querySelector('span') || document.createElement('span');
            span.textContent = `–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: ${login}`;
            if (!userInfoElement.querySelector('span')) {
                userInfoElement.prepend(span);
            }
        }
        
        if (authLinksElement) {
            authLinksElement.style.display = isAuth ? 'none' : 'block';
        }
    }
    
    // –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ—Ä–æ–±–∫–∏
    function generateBoxes(boxes) {
        const container = document.querySelector('.boxes-container');
        if (!container) return;
        
        container.innerHTML = '';
        
        boxes.forEach(box => {
            const boxWrapper = document.createElement('div');
            boxWrapper.className = 'box-wrapper';
            boxWrapper.style.top = `${box.top}%`;
            boxWrapper.style.left = `${box.left}%`;
            
            const boxDiv = document.createElement('div');
            boxDiv.className = `box ${box.opened ? 'opened' : ''}`;
            
            if (box.can_open && !box.opened) {
                const button = document.createElement('button');
                button.className = 'box-btn';
                button.type = 'button';
                button.onclick = () => openBox(box.id);
                
                const img = document.createElement('img');
                img.src = box.gift_image;
                img.alt = `–ö–æ—Ä–æ–±–∫–∞ ${box.number}`;
                
                button.appendChild(img);
                boxDiv.appendChild(button);
            } else {
                const div = document.createElement('div');
                div.className = 'box-btn';
                
                const img = document.createElement('img');
                img.src = box.gift_image;
                img.alt = `–ö–æ—Ä–æ–±–∫–∞ ${box.number}`;
                
                div.appendChild(img);
                
                if (box.opened) {
                    const span = document.createElement('span');
                    span.className = 'opened-label';
                    span.textContent = '‚úì';
                    div.appendChild(span);
                } else if (box.require_auth) {
                    const span = document.createElement('span');
                    span.className = 'lock-label';
                    span.textContent = 'üîí';
                    div.appendChild(span);
                }
                
                boxDiv.appendChild(div);
            }
            
            const numberDiv = document.createElement('div');
            numberDiv.className = 'box-number';
            numberDiv.textContent = box.number;
            boxDiv.appendChild(numberDiv);
            
            boxWrapper.appendChild(boxDiv);
            container.appendChild(boxWrapper);
        });
    }
    
    function showGift(data) {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π gift display –µ—Å–ª–∏ –µ—Å—Ç—å
        const oldDisplay = document.querySelector('.gift-display');
        if (oldDisplay) {
            oldDisplay.remove();
        }
        
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
        const giftDisplay = document.createElement('div');
        giftDisplay.className = 'gift-display';
        giftDisplay.innerHTML = `
            <h3>üéâ –ö–æ—Ä–æ–±–∫–∞ ‚Ññ${data.number} –æ—Ç–∫—Ä—ã—Ç–∞!</h3>
            <p class="congrats">${data.congratulation}</p>
            <img src="${data.gift_image}" alt="–ü–æ–¥–∞—Ä–æ–∫" class="gift-img">
        `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
        const container = document.querySelector('.boxes-container');
        if (container && container.parentNode) {
            container.parentNode.insertBefore(giftDisplay, container.nextSibling);
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
        giftDisplay.style.animation = 'fadeIn 0.5s';
        
        // –ü—Ä—è—á–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        hideMessage();
    }
    
    function hideGiftDisplay() {
        const giftDisplay = document.querySelector('.gift-display');
        if (giftDisplay) {
            giftDisplay.remove();
        }
    }
    
    function hideMessage() {
        const message = document.querySelector('.message');
        if (message) {
            message.style.display = 'none';
        }
    }
    
    function showError(message) {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        removeOldMessages();
        
        // –°–æ–∑–¥–∞–µ–º –±–ª–æ–∫ —Å –æ—à–∏–±–∫–æ–π
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error';
        errorDiv.textContent = message;
        
        // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞
        const h1 = document.querySelector('h1');
        if (h1 && h1.parentNode) {
            h1.parentNode.insertBefore(errorDiv, h1.nextSibling);
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.remove();
            }
        }, 5000);
    }
    
    function showSuccess(message) {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        removeOldMessages();
        
        // –°–æ–∑–¥–∞–µ–º –±–ª–æ–∫ —Å —É—Å–ø–µ—Ö–æ–º
        const successDiv = document.createElement('div');
        successDiv.className = 'success';
        successDiv.textContent = message;
        
        // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞
        const h1 = document.querySelector('h1');
        if (h1 && h1.parentNode) {
            h1.parentNode.insertBefore(successDiv, h1.nextSibling);
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            if (successDiv.parentNode) {
                successDiv.remove();
            }
        }, 5000);
    }
    
    function removeOldMessages() {
        const errors = document.querySelectorAll('.error, .success');
        errors.forEach(msg => {
            if (msg.parentNode) {
                msg.remove();
            }
        });
    }
</script>
{% endblock %}

{% block main %}
<h1>üéÅ–ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—èüéÅ</h1>

{% if auth %}
<div class="user-info">
    <span>–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: {{ login }}</span> | <a href="/lab9/logout">–í—ã–π—Ç–∏</a>
    <form class="santa-form">
        <button type="button" class="santa-btn">üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑</button>
    </form>
</div>
{% endif %}

<div class="stats">
    <p>–û—Ç–∫—Ä—ã—Ç–æ: <span id="opened-count">0</span>/3 | –û—Å—Ç–∞–ª–æ—Å—å: <span id="remaining-count">10</span></p>
    {% if not auth %}
    <p><a href="/lab9/login"><i>–í–æ–π—Ç–∏</i></a> | <a href="/lab9/register"><i>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</i></a></p>
    {% endif %}
</div>

<div class="boxes-container">
    <!-- –ö–æ—Ä–æ–±–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<div class="message">
    <p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–æ—Ä–æ–±–∫—É, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–¥–∞—Ä–æ–∫</p>
</div>
{% endblock %}